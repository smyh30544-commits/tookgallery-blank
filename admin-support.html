<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ù†Ù„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† - Took Gallery</title>
    <style>
        body {
            background: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }
        
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .tickets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .ticket-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .ticket-card:hover {
            transform: translateY(-5px);
        }
        
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff3b8d, #ff6bac);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-new {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .status-pending {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .message-preview {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .ticket-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
        }
        
        /* Ù…Ø¯Ø§Ù„ Ú†Øª */
        .chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .chat-modal.active {
            display: flex;
        }
        
        .chat-window {
            background: white;
            width: 90%;
            max-width: 800px;
            height: 80vh;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1 style="color: #333; margin-bottom: 10px;">ğŸ¯ Ù¾Ù†Ù„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</h1>
            <p style="color: #666;">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø² Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
            <button onclick="refreshTickets()" style="
                background: #4CAF50;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 10px;
            ">
                <i class="fas fa-sync-alt"></i> Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
            </button>
        </div>
        
        <div class="tickets-grid" id="ticketsContainer">
            <!-- ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
    </div>
    
    <!-- Ù…Ø¯Ø§Ù„ Ú†Øª -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-window" id="chatWindow">
            <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ú†Øª -->
        </div>
    </div>

    <script>
        // ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡
        let tickets = JSON.parse(localStorage.getItem('adminTickets')) || [
            {
                id: 1,
                userId: 'user123',
                userName: 'Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ',
                userPhone: 'Û°Û¹Û±Û²Û±Û²Û³Û´ÛµÛ¶Û·',
                message: 'Ø³ÙØ§Ø±Ø´ Ù…Ù† Ø¯Ø± Ú†Ù‡ Ø­Ø§Ù„ØªÛŒ Ù‡Ø³ØªØŸ Ù„Ø·ÙØ§Ù‹ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ù…Ù† Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.',
                status: 'new',
                timestamp: new Date().toISOString(),
                messages: [
                    { sender: 'user', text: 'Ø³ÙØ§Ø±Ø´ Ù…Ù† Ø¯Ø± Ú†Ù‡ Ø­Ø§Ù„ØªÛŒ Ù‡Ø³ØªØŸ', time: 'Û±Û´:Û³Û°' },
                    { sender: 'admin', text: 'Ø¨Ø§ Ø³Ù„Ø§Ù…ØŒ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´ Ø®ÙˆØ¯ Ø±Ø§ Ø¨ÙØ±Ø³ØªÛŒØ¯.', time: 'Û±Û´:Û³Û²' }
                ]
            }
        ];
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§
        function loadTickets() {
            const container = document.getElementById('ticketsContainer');
            let html = '';
            
            tickets.forEach(ticket => {
                html += `
                    <div class="ticket-card" onclick="openChat(${ticket.id})">
                        <div class="ticket-header">
                            <div class="user-info">
                                <div class="user-avatar">
                                    ${ticket.userName.charAt(0)}
                                </div>
                                <div>
                                    <div style="font-weight: 500;">${ticket.userName}</div>
                                    <div style="font-size: 12px; color: #666;">${ticket.userPhone}</div>
                                </div>
                            </div>
                            <span class="status-badge status-${ticket.status}">
                                ${ticket.status === 'new' ? 'Ø¬Ø¯ÛŒØ¯' : 
                                  ticket.status === 'pending' ? 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ' : 'Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡'}
                            </span>
                        </div>
                        
                        <div class="message-preview">
                            ${ticket.message}
                        </div>
                        
                        <div class="ticket-footer">
                            <span>${new Date(ticket.timestamp).toLocaleString('fa-IR')}</span>
                            <span>${ticket.messages.length} Ù¾ÛŒØ§Ù…</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú†Øª
        function openChat(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ"
            ticket.status = 'pending';
            localStorage.setItem('adminTickets', JSON.stringify(tickets));
            
            // Ø³Ø§Ø®Øª Ù¾Ù†Ø¬Ø±Ù‡ Ú†Øª
            const modal = document.getElementById('chatModal');
            const chatWindow = document.getElementById('chatWindow');
            
            let chatHTML = `
                <div style="
                    background: linear-gradient(90deg, #ff3b8d, #ff6bac);
                    color: white;
                    padding: 20px;
                    border-radius: 15px 15px 0 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <div>
                        <h3 style="margin: 0;">${ticket.userName}</h3>
                        <p style="margin: 5px 0 0; opacity: 0.9;">${ticket.userPhone}</p>
                    </div>
                    <button onclick="closeChat()" style="
                        background: none;
                        border: none;
                        color: white;
                        font-size: 24px;
                        cursor: pointer;
                    ">Ã—</button>
                </div>
                
                <div id="adminChatBody" style="
                    flex: 1;
                    padding: 20px;
                    overflow-y: auto;
                    background: #f8f9fa;
                ">
                    <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
                </div>
                
                <div style="
                    padding: 20px;
                    border-top: 1px solid #eee;
                    display: flex;
                    gap: 10px;
                ">
                    <input type="text" id="adminMessageInput" 
                           placeholder="Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." 
                           style="flex: 1; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 25px;"
                           onkeypress="if(event.key === 'Enter') sendAdminMessage(${ticketId})">
                    <button onclick="sendAdminMessage(${ticketId})" style="
                        background: #ff3b8d;
                        color: white;
                        border: none;
                        width: 50px;
                        height: 50px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 20px;
                    ">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `;
            
            chatWindow.innerHTML = chatHTML;
            modal.classList.add('active');
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
            loadAdminChat(ticketId);
        }
        
        // Ø¨Ø³ØªÙ† Ú†Øª
        function closeChat() {
            document.getElementById('chatModal').classList.remove('active');
            loadTickets(); // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª
        }
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú†Øª
        function loadAdminChat(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            const container = document.getElementById('adminChatBody');
            
            if (!ticket || !container) return;
            
            let html = '';
            ticket.messages.forEach(msg => {
                html += `
                    <div style="
                        max-width: 70%;
                        margin-bottom: 15px;
                        padding: 12px 16px;
                        border-radius: 15px;
                        background: ${msg.sender === 'user' ? '#e3f2fd' : 'white'};
                        margin-${msg.sender === 'user' ? 'right' : 'left'}: auto;
                        margin-${msg.sender === 'user' ? 'left' : 'right'}: 30px;
                        border-bottom-${msg.sender === 'user' ? 'right' : 'left'}-radius: 5px;
                        box-shadow: ${msg.sender === 'user' ? 'none' : '0 2px 5px rgba(0,0,0,0.1)'};
                    ">
                        <div style="font-weight: 500; margin-bottom: 5px;">
                            ${msg.sender === 'user' ? ticket.userName : 'Ø´Ù…Ø§ (Ù¾Ø´ØªÛŒØ¨Ø§Ù†)'}
                        </div>
                        <div>${msg.text}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px; text-align: left;">
                            ${msg.time}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }
        
        // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØªÙˆØ³Ø· Ù¾Ø´ØªÛŒØ¨Ø§Ù†
        function sendAdminMessage(ticketId) {
            const input = document.getElementById('adminMessageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ù¾Ø´ØªÛŒØ¨Ø§Ù†
            ticket.messages.push({
                sender: 'admin',
                text: text,
                time: new Date().toLocaleTimeString('fa-IR')
            });
            
            // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª ØªÛŒÚ©Øª
            ticket.status = 'answered';
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
            localStorage.setItem('adminTickets', JSON.stringify(tickets));
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú†Øª
            input.value = '';
            loadAdminChat(ticketId);
        }
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§
        function refreshTickets() {
            // Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø² localStorage Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            const userMessages = JSON.parse(localStorage.getItem('supportMessages')) || [];
            
            userMessages.forEach((msg, index) => {
                if (!tickets.some(t => t.userId === `user${index}`)) {
                    tickets.push({
                        id: tickets.length + 1,
                        userId: `user${index}`,
                        userName: msg.name || 'Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯',
                        userPhone: msg.phone || 'Ù†Ø§Ù…Ø´Ø®Øµ',
                        message: msg.message,
                        status: 'new',
                        timestamp: new Date().toISOString(),
                        messages: [
                            { sender: 'user', text: msg.message, time: new Date().toLocaleTimeString('fa-IR') }
                        ]
                    });
                }
            });
            
            localStorage.setItem('adminTickets', JSON.stringify(tickets));
            loadTickets();
            alert('ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯');
        }
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        document.addEventListener('DOMContentLoaded', () => {
            loadTickets();
            
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
            setInterval(() => {
                refreshTickets();
            }, 30000);
        });
    </script>
</body>
  </html>
